<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t(lang, 'chat_with_vet') }} - Health Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .circular-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-hover {
            transition: all 0.3s ease;
        }
        
        .btn-hover:hover {
            transform: translateY(-2px);
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-slow {
            animation: pulse 3s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }
        
        .message-owner {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border-radius: 18px;
            border-bottom-right-radius: 4px;
        }
        
        .message-vet {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
        }
        
        .camera-modal {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .message-image:hover {
            transform: scale(1.05);
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-teal-50 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl">
        <!-- Main Container -->
        <div class="bg-white rounded-3xl shadow-2xl border border-green-200 pulse-slow">
            <!-- Header -->
            <div class="p-6 bg-blue-600 text-white rounded-t-3xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-100 p-2 rounded-full">
                            <img src="{{ url_for('static', filename='logo.jpg') }}" 
                                 alt="Health Kiosk Logo" 
                                 class="circular-logo">
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">üêæ {{ t(lang, 'chat_with_vet') }}</h1>
                            <p class="text-blue-100">Connect with veterinary professionals</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <div class="flex bg-blue-700 rounded-xl p-1">
                            <button class="lang-btn px-3 py-1 rounded-lg transition-all duration-300 {{ 'bg-white text-blue-600' if lang == 'en' else 'text-blue-100' }}" 
                                    onclick="setLanguage('en')">
                                English
                            </button>
                            <button class="lang-btn px-3 py-1 rounded-lg transition-all duration-300 {{ 'bg-white text-blue-600' if lang == 'hi' else 'text-blue-100' }}" 
                                    onclick="setLanguage('hi')">
                                ‡§π‡§ø‡§Ç‡§¶‡•Ä
                            </button>
                            <button class="lang-btn px-3 py-1 rounded-lg transition-all duration-300 {{ 'bg-white text-blue-600' if lang == 'kn' else 'text-blue-100' }}" 
                                    onclick="setLanguage('kn')">
                                ‡≤ï‡≤®‡≥ç‡≤®‡≤°
                            </button>
                        </div>
                        <a href="/patient/welcome" class="bg-blue-700 text-white px-4 py-2 rounded-lg btn-hover hover:bg-blue-800 transition duration-300">
                            <i class="fas fa-arrow-left mr-2"></i>{{ t(lang, 'back') }}
                        </a>
                    </div>
                </div>
            </div>

            <!-- Chat Content -->
            <div class="p-6">
                <!-- Vet Selection -->
                <div class="bg-blue-50 rounded-xl p-6 mb-6 fade-in">
                    <h3 class="text-xl font-bold text-blue-800 mb-4 text-center">
                        <i class="fas fa-stethoscope mr-2"></i>{{ t(lang, 'select_vet') }}
                    </h3>
                    <div class="space-y-4">
                        <select id="vetSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">{{ t(lang, 'select_vet') }}</option>
                            {% for doctor in doctors %}
                            <option value="{{ doctor.id }}">Dr. {{ doctor.name }} - {{ doctor.specialization }}</option>
                            {% endfor %}
                        </select>
                        <input type="text" id="animalId" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="{{ t(lang, 'enter_animal_id') }}">
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="bg-gray-50 rounded-xl p-4 mb-4 h-96 overflow-y-auto custom-scrollbar" id="messagesContainer">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-paw text-4xl mb-4 text-gray-300"></i>
                            <h3 class="text-xl font-semibold mb-2">{{ t(lang, 'select_vet_and_animal') }}</h3>
                            <p>Select a veterinarian and enter your animal ID to start chatting</p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="flex space-x-3">
                    <textarea id="messageInput" 
                              class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                              placeholder="{{ t(lang, 'type_message') }}..."
                              rows="1"
                              disabled></textarea>
                    <button class="camera-btn bg-teal-600 text-white w-12 h-12 rounded-xl flex items-center justify-center btn-hover hover:bg-teal-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            onclick="openCamera()" disabled>
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="send-btn bg-blue-600 text-white px-6 py-3 rounded-xl font-bold btn-hover hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            onclick="sendMessage()" disabled>
                        <i class="fas fa-paper-plane mr-2"></i>{{ t(lang, 'send_message') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="fixed inset-0 z-50 camera-modal hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">
                <i class="fas fa-camera mr-2"></i>{{ t(lang, 'take_photo') }}
            </h3>
            
            <video id="cameraVideo" class="w-full rounded-xl mb-4" autoplay playsinline></video>
            <canvas id="cameraCanvas" class="hidden"></canvas>
            
            <img id="capturedImage" class="w-full rounded-xl mb-4 hidden" alt="Captured Photo">
            
            <div class="flex space-x-3 justify-center">
                <button onclick="capturePhoto()" id="captureBtn" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold btn-hover hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-camera mr-2"></i>{{ t(lang, 'take_photo') }}
                </button>
                <button onclick="retakePhoto()" id="retakeBtn" class="bg-yellow-600 text-white px-6 py-3 rounded-xl font-bold btn-hover hover:bg-yellow-700 transition duration-300 hidden">
                    <i class="fas fa-redo mr-2"></i>{{ t(lang, 'retake') }}
                </button>
                <button onclick="sendPhoto()" id="sendPhotoBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold btn-hover hover:bg-green-700 transition duration-300 hidden">
                    <i class="fas fa-paper-plane mr-2"></i>{{ t(lang, 'send_photo') }}
                </button>
                <button onclick="closeCamera()" class="bg-gray-500 text-white px-6 py-3 rounded-xl font-bold btn-hover hover:bg-gray-600 transition duration-300">
                    <i class="fas fa-times mr-2"></i>{{ t(lang, 'cancel') }}
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStream = null;
        let capturedPhoto = null;
        let selectedVetId = null;
        let animalId = null;
        let refreshInterval = null;

        function setLanguage(lang) {
            window.location.href = `/set_language/${lang}`;
        }

        // Vet selection
        document.getElementById('vetSelect').addEventListener('change', function() {
            selectedVetId = this.value;
            animalId = document.getElementById('animalId').value.trim();
            updateSendButton();
            if (selectedVetId && animalId) {
                loadMessages();
                startAutoRefresh();
            }
        });

        document.getElementById('animalId').addEventListener('input', function() {
            animalId = this.value.trim();
            updateSendButton();
            if (selectedVetId && animalId) {
                loadMessages();
                startAutoRefresh();
            }
        });

        function updateSendButton() {
            const canSend = selectedVetId && animalId;
            document.getElementById('messageInput').disabled = !canSend;
            document.querySelector('.camera-btn').disabled = !canSend;
            document.querySelector('.send-btn').disabled = !canSend;
        }

        async function loadMessages() {
            if (!selectedVetId || !animalId) return;

            try {
                const response = await fetch(`/api/chat/messages/${animalId}/${selectedVetId}`);
                const result = await response.json();

                const container = document.getElementById('messagesContainer');
                
                if (result.success && result.messages.length > 0) {
                    let html = '';
                    result.messages.forEach(msg => {
                        const isOwner = msg.sender_type === 'patient' || msg.sender_type === 'animal_owner';
                        const messageClass = isOwner ? 'message-owner' : 'message-vet';
                        const alignmentClass = isOwner ? 'justify-end' : 'justify-start';
                        const senderName = isOwner ? 'You' : 'Veterinarian';
                        
                        html += `
                            <div class="flex ${alignmentClass} mb-4 fade-in">
                                <div class="max-w-xs lg:max-w-md ${messageClass} p-4 shadow-sm">
                                    <div class="font-semibold mb-1 ${isOwner ? 'text-white' : 'text-blue-600'}">
                                        ${senderName}
                                    </div>
                                    <div class="${isOwner ? 'text-white' : 'text-gray-700'} mb-2">
                                        ${msg.content}
                                    </div>
                                    ${msg.image_data ? `
                                        <img src="data:image/jpeg;base64,${msg.image_data}" 
                                             class="message-image mb-2" 
                                             onclick="viewImage('${msg.image_data}')"
                                             alt="Shared photo">
                                    ` : ''}
                                    <div class="text-xs ${isOwner ? 'text-blue-100' : 'text-gray-500'}">
                                        ${new Date(msg.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full text-gray-500">
                            <div class="text-center">
                                <i class="fas fa-paw text-4xl mb-4 text-gray-300"></i>
                                <h3 class="text-xl font-semibold mb-2">{{ t(lang, "no_messages") }}</h3>
                                <p>Start a conversation about your animal</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message || !selectedVetId || !animalId) return;

            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        patient_id: animalId,
                        doctor_id: selectedVetId,
                        message: message,
                        sender_type: 'animal_owner'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    loadMessages();
                } else {
                    alert('{{ t(lang, "error_sending_message") }}');
                }
            } catch (error) {
                alert('{{ t(lang, "network_error") }}');
            }
        }

        // Camera functions
        async function openCamera() {
            const modal = document.getElementById('cameraModal');
            modal.classList.remove('hidden');

            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('cameraVideo').srcObject = currentStream;
            } catch (error) {
                alert('{{ t(lang, "camera_error") }}');
                closeCamera();
            }
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            modal.classList.add('hidden');
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('sendPhotoBtn').classList.add('hidden');
            document.getElementById('capturedImage').classList.add('hidden');
            document.getElementById('cameraVideo').classList.remove('hidden');
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const image = document.getElementById('capturedImage');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            capturedPhoto = canvas.toDataURL('image/jpeg').split(',')[1];
            image.src = 'data:image/jpeg;base64,' + capturedPhoto;

            video.classList.add('hidden');
            image.classList.remove('hidden');
            
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            document.getElementById('sendPhotoBtn').classList.remove('hidden');
        }

        function retakePhoto() {
            const video = document.getElementById('cameraVideo');
            const image = document.getElementById('capturedImage');

            video.classList.remove('hidden');
            image.classList.add('hidden');
            
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('sendPhotoBtn').classList.add('hidden');
            
            capturedPhoto = null;
        }

        function viewImage(imageData) {
            const modal = document.getElementById('cameraModal');
            modal.innerHTML = `
                <div class="bg-white rounded-3xl shadow-2xl p-6 max-w-2xl">
                    <img src="data:image/jpeg;base64,${imageData}" 
                         class="w-full h-auto rounded-xl mb-4 max-h-96 object-contain"
                         alt="View photo">
                    <div class="text-center">
                        <button onclick="closeCamera()" class="bg-gray-500 text-white px-6 py-3 rounded-xl font-bold btn-hover hover:bg-gray-600 transition duration-300">
                            <i class="fas fa-times mr-2"></i>{{ t(lang, "cancel") }}
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        async function sendPhoto() {
            if (!capturedPhoto || !selectedVetId || !animalId) return;

            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        patient_id: animalId,
                        doctor_id: selectedVetId,
                        message: '{{ t(lang, "photo_attached") }}',
                        image_data: capturedPhoto,
                        sender_type: 'animal_owner'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    closeCamera();
                    loadMessages();
                } else {
                    alert('{{ t(lang, "error_sending_photo") }}');
                }
            } catch (error) {
                alert('{{ t(lang, "network_error") }}');
            }
        }

        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(loadMessages, 3000);
        }

        // Allow Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Stop auto-refresh when leaving page
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>